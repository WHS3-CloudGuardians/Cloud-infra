# custodian-setup/Makefile

ZIP_PATH_MAILER = modules/custodian-mailer/c7n-mailer.zip
BUILD_DIR_MAILER = .build/c7n-mailer

ZIP_PATH_CT = modules/custodian-cloudtrail/custodian.zip
BUILD_DIR_CT = .build/custodian-cloudtrail

.PHONY: all plan validate build build-mailer build-cloudtrail deploy clean debug-build debug-tf debug

all: build deploy

plan: build
	@echo "ğŸ” Planning Terraform..."
	terraform plan -var-file=env/dev.tfvars

validate:
	@echo "ğŸ” Validating Terraform..."
	terraform validate

build: build-mailer build-cloudtrail

# 1) c7n-mailer íŒ¨í‚¤ì§•
build-mailer:
	@echo "ğŸ”§ Building c7n-mailer.zip..."
	rm -rf $(BUILD_DIR_MAILER)
	mkdir -p $(BUILD_DIR_MAILER)/templates
	cp c7n-mailer.yml $(BUILD_DIR_MAILER)/
	cp -r templates/* $(BUILD_DIR_MAILER)/templates/
	pip install c7n-mailer -t $(BUILD_DIR_MAILER)
	cd $(BUILD_DIR_MAILER) && zip -r ../../$(ZIP_PATH_MAILER) .

# 2) custodian-cloudtrail íŒ¨í‚¤ì§•
build-cloudtrail:
	@echo "ğŸ”§ Building custodian-cloudtrail.zip..."
	rm -rf $(BUILD_DIR_CT)
	mkdir -p $(BUILD_DIR_CT)
	pip install c7n[boto3] -t $(BUILD_DIR_CT)
	cp -r policies/cloudtrail $(BUILD_DIR_CT)/policies
	cp custodian-lambda.py $(BUILD_DIR_CT)/custodian_lambda.py
	cd $(BUILD_DIR_CT) && zip -r ../../$(ZIP_PATH_CT) .

deploy: build
	@echo "ğŸš€ Deploying with Terraform..."
	terraform apply -auto-approve -var-file=env/dev.tfvars

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf .build
	rm -f $(ZIP_PATH_MAILER) $(ZIP_PATH_CT)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë””ë²„ê¹… ì „ìš© íƒ€ê²Ÿ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

debug-build:
	@echo "ğŸ” Inspecting mailer buildâ€¦"    # TABìœ¼ë¡œ ë“¤ì—¬ì“°ê¸°
	tree $(BUILD_DIR_MAILER) || echo "âš ï¸ tree not found"
	unzip -l $(ZIP_PATH_MAILER)
	@echo "ğŸ” Inspecting cloudtrail buildâ€¦"
	tree $(BUILD_DIR_CT)     || echo "âš ï¸ tree not found"
	unzip -l $(ZIP_PATH_CT)

debug-tf: plan validate
	@echo "ğŸ” Terraform checks completed"

debug: debug-build debug-tf
