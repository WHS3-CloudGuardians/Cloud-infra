# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (í•„ìš”ì‹œ .env ì§€ì›)
include .env
export

ZIP_PATH=modules/custodian-mailer/c7n-mailer.zip
BUILD_DIR=.build/c7n-mailer

.PHONY:  all clean build deploy plan validate

# ì „ì²´ ì‘ì—…: zip ìƒì„± â†’ Terraform apply
all: build deploy

# Terraform Plan
plan:
	terraform plan -var-file=env/dev.tfvars

# Terraform Validate
validate:
	@echo "ğŸ” Validating Terraform code..."
	terraform validate

# c7n-mailer íŒ¨í‚¤ì§€ ë¹Œë“œ
build:
	@echo "ğŸ”§ Building c7n-mailer.zip..."
	rm -rf $(BUILD_DIR)
	mkdir -p $(BUILD_DIR)/templates
	cp c7n-mailer.yml $(BUILD_DIR)/
	cp -r templates/* $(BUILD_DIR)/templates/
	pip install c7n-mailer -t $(BUILD_DIR)
	cd $(BUILD_DIR) && zip -r ../../$(ZIP_PATH) .

# Terraform ë°°í¬
deploy:
	@echo "ğŸš€ Running terraform apply..."
	terraform apply -auto-approve

# ì •ë¦¬
clean:
	rm -rf .build
	rm -f $(ZIP_PATH)
